name: CD — Build, Push & Deploy

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Override image tag (defaults to Git SHA on branch or tag name on release)"
        required: false

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false   # never cancel an in-flight deploy

env:
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}           # nodeprodacr.azurecr.io
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}       # node--prod--aks
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}   # RamToptal
  NAMESPACE: node--prod--ns
  KEY_VAULT_NAME: node-prod-kv

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.resolve-tag.outputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ── Resolve image tag ──────────────────────────────────────────────
      - name: Resolve image tag
        id: resolve-tag
        run: |
          if [[ -n "${{ github.event.inputs.image_tag }}" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Strip refs/tags/ prefix: v1.2.3
            TAG="${GITHUB_REF_NAME}"
          else
            # Branch push: use short SHA
            TAG="${GITHUB_SHA::8}"
          fi
          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Resolved image tag: ${TAG}"

      # ── Log in to ACR ─────────────────────────────────────────────────
      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ── Set up Docker Buildx (layer cache support) ────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── Build & push API image ─────────────────────────────────────────
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.api
          target: production
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/node-api:${{ steps.resolve-tag.outputs.image_tag }}
          cache-from: type=registry,ref=${{ env.ACR_REGISTRY }}/node-api:cache
          cache-to: type=registry,ref=${{ env.ACR_REGISTRY }}/node-api:cache,mode=max

      # ── Build & push Web image ─────────────────────────────────────────
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.web
          target: production
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/node-web:${{ steps.resolve-tag.outputs.image_tag }}
          cache-from: type=registry,ref=${{ env.ACR_REGISTRY }}/node-web:cache
          cache-to: type=registry,ref=${{ env.ACR_REGISTRY }}/node-web:cache,mode=max

  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ── Authenticate to Azure ─────────────────────────────────────────
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── Set AKS kubectl context ───────────────────────────────────────
      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      # ── Fetch runtime secrets from Azure Key Vault ────────────────────
      - name: Fetch secrets from Key Vault
        id: kv-secrets
        run: |
          PG_HOST=$(az keyvault secret show \
            --vault-name "${{ env.KEY_VAULT_NAME }}" \
            --name postgres-fqdn --query value -o tsv)
          APP_RW_PASS=$(az keyvault secret show \
            --vault-name "${{ env.KEY_VAULT_NAME }}" \
            --name app-rw-password --query value -o tsv)
          REDIS_KEY=$(az keyvault secret show \
            --vault-name "${{ env.KEY_VAULT_NAME }}" \
            --name redis-primary-key --query value -o tsv)
          REDIS_HOST=$(az keyvault secret show \
            --vault-name "${{ env.KEY_VAULT_NAME }}" \
            --name redis-hostname --query value -o tsv)
          # Mask all secrets before storing in outputs
          echo "::add-mask::${APP_RW_PASS}"
          echo "::add-mask::${REDIS_KEY}"
          echo "pg_host=${PG_HOST}"           >> "$GITHUB_OUTPUT"
          echo "app_rw_pass=${APP_RW_PASS}"   >> "$GITHUB_OUTPUT"
          echo "redis_key=${REDIS_KEY}"        >> "$GITHUB_OUTPUT"
          echo "redis_host=${REDIS_HOST}"      >> "$GITHUB_OUTPUT"

      # ── Ensure namespace & RBAC exist (idempotent) ───────────────────
      - name: Apply namespace and RBAC manifests
        run: |
          kubectl apply -f k8s/manifests/namespace.yaml
          kubectl apply -f k8s/manifests/rbac.yaml

      # ── Create / refresh ACR pull secret ─────────────────────────────
      - name: Refresh ACR image-pull secret
        run: |
          kubectl create secret docker-registry acr-pull-secret \
            --namespace="${{ env.NAMESPACE }}" \
            --docker-server="${{ env.ACR_REGISTRY }}" \
            --docker-username="${{ secrets.ACR_USERNAME }}" \
            --docker-password="${{ secrets.ACR_PASSWORD }}" \
            --save-config \
            --dry-run=client -o yaml | kubectl apply -f -

      # ── Helm: upgrade/install API chart ──────────────────────────────
      - name: Helm deploy API
        run: |
          helm upgrade --install node-api ./k8s/helm/api \
            --namespace="${{ env.NAMESPACE }}" \
            --create-namespace \
            -f k8s/helm/values-prod.yaml \
            --set image.repository="${{ env.ACR_REGISTRY }}/node-api" \
            --set image.tag="${{ needs.build-and-push.outputs.image_tag }}" \
            --set dbSecret.user="app_rw" \
            --set dbSecret.password="${{ steps.kv-secrets.outputs.app_rw_pass }}" \
            --set db.host="${{ steps.kv-secrets.outputs.pg_host }}" \
            --atomic \
            --timeout=5m \
            --wait

      # ── Helm: upgrade/install Web chart ──────────────────────────────
      - name: Helm deploy Web
        run: |
          REDIS_URL="rediss://:${{ steps.kv-secrets.outputs.redis_key }}@${{ steps.kv-secrets.outputs.redis_host }}:6380"
          helm upgrade --install node-web ./k8s/helm/web \
            --namespace="${{ env.NAMESPACE }}" \
            --create-namespace \
            -f k8s/helm/values-prod.yaml \
            --set image.repository="${{ env.ACR_REGISTRY }}/node-web" \
            --set image.tag="${{ needs.build-and-push.outputs.image_tag }}" \
            --set appSecret.redisUrl="${REDIS_URL}" \
            --atomic \
            --timeout=5m \
            --wait

      # ── Verify rollout ────────────────────────────────────────────────
      - name: Verify rollouts
        run: |
          echo "=== API pods ==="
          kubectl rollout status deployment/node-api \
            --namespace="${{ env.NAMESPACE }}" --timeout=3m
          echo "=== Web pods ==="
          kubectl rollout status deployment/node-web \
            --namespace="${{ env.NAMESPACE }}" --timeout=3m
          echo ""
          echo "=== Running pods ==="
          kubectl get pods -n "${{ env.NAMESPACE }}" -o wide

      # ── Summary ───────────────────────────────────────────────────────
      - name: Deployment summary
        run: |
          echo "### Deployment complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image tag | \`${{ needs.build-and-push.outputs.image_tag }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Cluster | \`${{ env.AKS_CLUSTER_NAME }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Namespace | \`${{ env.NAMESPACE }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Triggered by | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
